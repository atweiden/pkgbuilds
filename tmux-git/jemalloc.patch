From 31b9b80fa76c21aed68d1c921ef70829a84fdfe9 Mon Sep 17 00:00:00 2001
From: Dan Aloni <alonid@gmail.com>
Date: Mon, 28 Aug 2017 21:10:59 +0300
Subject: [PATCH] Add --enable-jemalloc to `configure`

---
 configure.ac | 23 +++++++++++++++++++++++
 1 file changed, 23 insertions(+)

diff --git a/configure.ac b/configure.ac
index f6ed390eb..d46954200 100644
--- a/configure.ac
+++ b/configure.ac
@@ -224,6 +224,29 @@ else
 	fi
 fi
 
+# jemalloc
+AC_ARG_ENABLE(jemalloc,
+        [AS_HELP_STRING([--enable-jemalloc],[Enable jemalloc support @<:@default=no@:>@])],
+        [case "${enableval}" in
+         yes) enable_jemalloc="yes" ;;
+          no) enable_jemalloc="no" ;;
+           *) AC_MSG_ERROR(bad value ${enableval} for --enable-jemalloc) ;;
+         esac],
+        [enable_jemalloc="no"]
+)
+AM_CONDITIONAL(ENABLE_JEMALLOC, test x$enable_jemalloc = xyes)
+if test "$enable_jemalloc" = "yes"; then
+  AC_CHECK_LIB(
+    [jemalloc],
+    [malloc_stats_print],
+    [LIBS="$LIBS -ljemalloc"
+     AC_DEFINE(HAVE_JEMALLOC, 1, [jemalloc support is integrated.])
+    ],
+    [AC_MSG_FAILURE([jemalloc library is missing])],
+    []
+    )
+fi
+
 # Look for utempter.
 AC_ARG_ENABLE(
 	utempter,
